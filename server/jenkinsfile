pipeline {
    agent any

    environment {
        // TODO: Replace with your actual registry URL
        DOCKER_REGISTRY = "your-docker-registry"
        // Using build number as tag for versioning
        IMAGE_TAG = "${BUILD_NUMBER}"
        FL_SERVER_IMAGE = "${DOCKER_REGISTRY}/fl-server:${IMAGE_TAG}"
        MODEL_API_IMAGE = "${DOCKER_REGISTRY}/model-api:${IMAGE_TAG}"
    }

    stages {
        stage('Build') {
            steps {
                script {
                    echo 'Building Docker images...'
                    // Build fl-server image using Dockerfile.train
                    sh "docker build -t ${FL_SERVER_IMAGE} -f server/Dockerfile.train server"
                    
                    // Build model-api image using Dockerfile.serve
                    sh "docker build -t ${MODEL_API_IMAGE} -f server/Dockerfile.serve server"
                }
            }
        }

        stage('Push') {
            steps {
                script {
                    echo 'Pushing Docker images...'
                    // Assuming docker login is handled via Jenkins credentials or agent configuration
                    // If using credentials:
                    // withCredentials([usernamePassword(credentialsId: 'docker-creds', passwordVariable: 'PASS', usernameVariable: 'USER')]) {
                    //     sh "echo $PASS | docker login -u $USER --password-stdin ${DOCKER_REGISTRY}"
                    // }
                    
                    sh "docker push ${FL_SERVER_IMAGE}"
                    sh "docker push ${MODEL_API_IMAGE}"
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    echo 'Deploying to Kubernetes...'
                    
                    // Update deployment.yaml with new image tags
                    // We use sed to replace the placeholder or latest tags with the specific build tag
                    sh "sed -i 's|image: fl-server:latest|image: ${FL_SERVER_IMAGE}|g' server/k8s/deployment.yaml"
                    sh "sed -i 's|image: model-api:latest|image: ${MODEL_API_IMAGE}|g' server/k8s/deployment.yaml"
                    
                    // Apply Kubernetes manifests
                    sh "kubectl apply -f server/k8s/deployment.yaml"
                    sh "kubectl apply -f server/k8s/service.yaml"
                    
                    // Verify deployment
                    sh "kubectl rollout status deployment/fl-server"
                    sh "kubectl rollout status deployment/model-api"
                }
            }
        }
    }
    
    post {
        always {
            // Clean up workspace or images if needed
            echo 'Pipeline finished.'
        }
        success {
            echo 'Deployment successful!'
        }
        failure {
            echo 'Deployment failed.'
        }
    }
}
